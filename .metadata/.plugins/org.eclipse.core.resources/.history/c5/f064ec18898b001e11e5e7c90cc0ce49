/*
 * fsm_uart.c
 *
 *  Created on: Nov 23, 2023
 *      Author: Loke
 */

#include "global.h"

int status = INIT;
int command = INIT;
int command_status = COMMAND_FALSE;
uint8_t temp = 0;
uint8_t index_buffer = 0;
uint8_t buffer_flag = 0;
uint8_t buffer[MAX_BUFFER_SIZE];
uint32_t ADC_value = 0;
char str[60];
int command_size[10] = {0,1,2,3,4,5,6,7,8,9};

void buffer_clean(){
	memset(buffer, 0, sizeof(buffer));
	index_buffer = 0;
}

int get_commmand(){
	switch (index_buffer - 2) {
		case command_size[3]:
			if(buffer[1] == 'R' && buffer[2] == 'S' && buffer[3] == 'T')
			{
				return RST;
			}
			break;
		case command_size[2]:

			break;
		default:
			break;
	}
}

void command_parser_fsm(){
	switch(status){
	case INIT:
		status = STANDBY;
		break;
	case STANDBY:
		if(buffer[index_buffer - 1] == '#'){
			status = COMMAND_READ;
		}
	case COMMAND_READ:
		command = get_command();
		switch (command) {
			case RST:
				command_status = COMMAND_START;
				status = STANDBY;

				break;
			case OK:
				command_status = COMMAND_STOP;
				break;
			default:
				break;
		}
		if(buffer[index_buffer - 1] == '#'){
			cmd = compare();
			if(cmd == RST){
				command_flag = 1;
				status = INIT;
				buffer_clean();
				break;
			}
			else if(cmd == OK){
				command_flag = 0;
				status = INIT;
				timer_flag[0] = 1;
				buffer_clean();
				break;
			}
		}
		break;
	default:
		break;
	}
}

void uart_communication_fsm(){
	switch(comand_status){
	case COMMAND_START:
		if(timer_flag[0] == 1){
			HAL_UART_Transmit(&huart2, (void*)str, sprintf(str, "\r\n!ADC=%lu#\r\n", ADC_value), 1000);
			setTimer(3000, 0);
		}
		break;
	default:
		break;
	}
}

